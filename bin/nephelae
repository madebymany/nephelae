#!/usr/bin/env ruby
require 'rubygems'
require 'daemons'
require 'nephelae'
require 'optparse'

settings = {}
logfile = ""
loglevel = nil

OptionParser.new do |o|
  o.banner << " command"
  o.on("-k", "--aws-access-key-id ACCESSKEY", "AWS Access Key to use for cloudwatch") do |v|
    settings[:aws_access_key_id] = v
  end
  o.on("-s", "--aws-secret-access-key SECRETKEY", "AWS Secret Access Key to use for cloudwatch") do |v|
    settings[:aws_secret_access_key] = v
  end

  o.on("-r", "--region REGION", "The region to use for cloudwatch") do |v|
    settings[:region] = v
  end

  o.on("-lf", "--logfile [FILEPATH]", "The filepath to log to") do |v|
    logfile = v || STDOUT
  end

  o.on("-ll", "--loglevel [LOGLEVEL]", "The level to log to") do |v|
    unless v.nil?
      DEBUG < INFO < WARN < ERROR < FATAL
      case v
      when "debug"
        loglevel = Logger::DEBUG
      when "info"
        loglevel = Logger::INFO
      when "warn"
        loglevel = Logger::WARN
      when "error"
        loglevel = Logger::ERROR
      when "fatal"
        loglevel = Logger::FATAL
      else
        loglevel = Logger::WARN
      end
    else
      loglevel = Logger::WARN
    end
  end
end.parse!

log = Logger.new(logfile)
log.level = loglevel
Nephelae::Logging.logger = log

new_argv = [ARGV.first]
Daemons.run_proc('nephelae', {ARGV: new_argv}) do
  r = Nephelae::Runner.new(settings)
  r.run
end
