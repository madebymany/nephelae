#!/usr/bin/env ruby
require 'rubygems'
require 'daemons'
require 'nephelae'
require 'optparse'
require 'yaml'

settings = {}
logfile = ""
loglevel = nil

cmd = ARGV.first

file = '/etc/nephelae.yml'
logfile = STDOUT
loglevel = Logger::WARN
logdir = '/var/log'

OptionParser.new do |o|
  o.banner << " command"

  o.on("--config CONFIGFILE", "The config file to use for plugins (and aws settin3yygs)") do |v|
    file = v
  end

  o.on("--logdir LOGDIR", "The directory to put log files") do |v|
    logdir = v
  end

  o.on("--loglevel LOGLEVEL", "The level to log to") do |v|
    case v.downcase
    when "debug"
      loglevel = Logger::DEBUG
    when "info"
      loglevel = Logger::INFO
    when "warn"
      loglevel = Logger::WARN
    when "error"
      loglevel = Logger::ERROR
    when "fatal"
      loglevel = Logger::FATAL
    else
      loglevel = Logger::WARN
    end unless v.nil?
  end
end.parse!

log = Logger.new(logfile)
log.level = loglevel
Nephelae::Logging.logger = log
File.open( file ) { |yf| settings = YAML::load( yf ) }

new_argv = [cmd]
Daemons.run_proc('nephelae', {ARGV: new_argv, log_dir: logdir, log_output: true, dir_mode: :system}) do
  r = Nephelae::Runner.new(settings)
  r.run
end
